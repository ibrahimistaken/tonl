var TONL=function(e){"use strict";var t=Object.defineProperty,n=(e,n,r)=>((e,n,r)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[n]=r)(e,"symbol"!=typeof n?n+"":n,r);function r(e){return null==e?"null":"boolean"==typeof e?"bool":"number"==typeof e?isFinite(e)&&Number.isInteger(e)?e>=0&&e<=4294967295?"u32":e>=-2147483648&&e<=2147483647?"i32":"f64":"f64":"string"==typeof e?"str":Array.isArray(e)?"list":"object"==typeof e?"obj":"str"}function i(e,t){const n=e.startsWith('"')?e.slice(1,-1).replace(/""/g,'"'):e;if("null"===n)return null;switch(t){case"null":return null;case"bool":return"true"===n;case"u32":if(!/^[0-9]+$/.test(n))throw new TypeError(`Invalid u32: must be decimal integer, got: ${n}`);const t=parseInt(n,10);if(!Number.isFinite(t)||t<0||t>4294967295)throw new RangeError(`Invalid u32: out of range (0-4294967295): ${t}`);if(t.toString()!==n)throw new RangeError(`Invalid u32: overflow detected: ${n}`);return t;case"i32":if(!/^-?[0-9]+$/.test(n))throw new TypeError(`Invalid i32: must be decimal integer, got: ${n}`);const r=parseInt(n,10);if(!Number.isFinite(r)||r<-2147483648||r>2147483647)throw new RangeError(`Invalid i32: out of range (-2147483648 to 2147483647): ${r}`);if(r.toString()!==n)throw new RangeError(`Invalid i32: overflow detected: ${n}`);return r;case"f64":const i=parseFloat(n);if(!Number.isFinite(i))throw new RangeError(`Invalid f64: NaN or Infinity not allowed: ${e}`);return i;default:return n}}function s(e){if(0===e.length)return!0;if(!e.every(e=>"object"==typeof e&&null!==e&&!Array.isArray(e)))return!1;const t=Object.keys(e[0]).sort();return e.every(e=>{const n=Object.keys(e).sort();return n.length===t.length&&n.every((e,n)=>e===t[n])})}function o(e,t){if(e.includes("\n")||e.includes('"""')){return`"""${e.replace(/\\/g,"\\\\").replace(/"""/g,'\\"""')}"""`}return function(e,t){return function(e,t){return""===e||"true"===e||"false"===e||"null"===e||"undefined"===e||"Infinity"===e||"-Infinity"===e||"NaN"===e||!!/^-?\d+$/.test(e)||!!/^-?\d*\.\d+$/.test(e)||!!/^-?\d+\.?\d*e[+-]?\d+$/i.test(e)||e.includes(t)||e.includes(":")||e.includes("{")||e.includes("}")||e.includes("#")||e.includes("\n")||e.includes("\t")||e.includes("\r")||e.startsWith(" ")||e.endsWith(" ")}(e,t)?`"${e.replace(/"/g,'""').replace(/\\/g,"\\\\")}"`:e}(e,t)}function c(e,t){return" ".repeat(e*t)}function a(e,t={}){const n=t.delimiter||",",r=t.includeTypes??!1,i=t.version||"1.0",s={delimiter:n,includeTypes:r,version:i,indent:void 0!==t.indent&&Number.isFinite(t.indent)&&t.indent>=0?t.indent:2,singleLinePrimitiveLists:t.singleLinePrimitiveLists??!0,currentIndent:0,seen:new WeakSet},o=[];o.push(`#version ${i}`),","!==n&&o.push(`#delimiter ${"\t"===n?"\\t":n}`);const c=u(e,"root",s);return c&&o.push(c),o.join("\n")}function u(e,t,n){if(null===e)return`${t}: null`;if(void 0===e)return"";if(Array.isArray(e))return function(e,t,n){if(n.seen?.has(e))throw new Error(`Circular reference detected at key: ${t}`);if(n.seen?.add(e),0===e.length)return`${t}[0]:`;const i=s(e),a=e[0];if(i&&a&&"object"==typeof a&&!Array.isArray(a)){if(e.every(e=>e&&Object.values(e).every(e=>null==e||"object"!=typeof e&&"function"!=typeof e))){const i=function(e){return 0===e.length?[]:Object.keys(e[0]).sort()}(e),s=[];for(const e of i){let t=e;if(n.includeTypes){const n=r(a[e]);"obj"!==n&&"list"!==n&&(t+=`:${n}`)}s.push(t)}const u=[`${t}[${e.length}]{${s.join(",")}}:`],l={...n,currentIndent:n.currentIndent+1};for(const t of e){if(!t||"object"!=typeof t||Array.isArray(t))continue;const e=[];for(const r of i){const i=t[r];if(null===i)e.push("null");else if(void 0===i)e.push("null");else if(!0===i||!1===i)e.push(String(i));else if("number"==typeof i)e.push(String(i));else{const t=o(String(i),n.delimiter);e.push(t)}}u.push(c(l.currentIndent,l.indent)+e.join(` ${n.delimiter} `))}return u.join("\n")}{const r=[`${t}[${e.length}]:`],i={...n,currentIndent:n.currentIndent+1};for(let t=0;t<e.length;t++){const s=e[t];if("object"==typeof s&&null!==s){const e=u(s,`[${t}]`,i);r.push(c(i.currentIndent,i.indent)+e)}else if(null===s)r.push(c(i.currentIndent,i.indent)+`[${t}]: null`);else if(!0===s||!1===s)r.push(c(i.currentIndent,i.indent)+`[${t}]: ${String(s)}`);else if("number"==typeof s)r.push(c(i.currentIndent,i.indent)+`[${t}]: ${String(s)}`);else if(void 0!==s){const e=o(String(s),n.delimiter);r.push(c(i.currentIndent,i.indent)+`[${t}]: ${e}`)}}return r.join("\n")}}if(e.every(e=>"object"!=typeof e||null===e)){const r=e.map(e=>null==e?"null":!0===e||!1===e||"number"==typeof e?String(e):o(String(e),n.delimiter));if(n.singleLinePrimitiveLists&&r.join(`${n.delimiter} `).length<80)return`${t}[${e.length}]: ${r.join(`${n.delimiter} `)}`;{const i=[`${t}[${e.length}]:`],s={...n,currentIndent:n.currentIndent+1};return i.push(c(s.currentIndent,s.indent)+r.join(` ${n.delimiter} `)),i.join("\n")}}{const r=[`${t}[${e.length}]:`],i={...n,currentIndent:n.currentIndent+1};for(let t=0;t<e.length;t++){const s=e[t];if("object"==typeof s&&null!==s){const e=u(s,`[${t}]`,i);r.push(c(i.currentIndent,i.indent)+e)}else if(null===s)r.push(c(i.currentIndent,i.indent)+`[${t}]: null`);else if(void 0!==s){const e=o(String(s),n.delimiter);r.push(c(i.currentIndent,i.indent)+`[${t}]: ${e}`)}}return r.join("\n")}}(e,t,n);if("object"==typeof e)return function(e,t,n){if(n.seen?.has(e))throw new Error(`Circular reference detected at key: ${t}`);n.seen?.add(e);const i=Object.keys(e).filter(t=>void 0!==e[t]).sort(),s=[],a=Object.values(e).some(e=>"object"==typeof e&&null!==e&&!Array.isArray(e));for(const o of i){const t=e[o];let i=o;if(n.includeTypes){const e=r(t);"obj"!==e&&"list"!==e&&(i+=`:${e}`)}s.push(i)}const l=`${t}{${s.join(",")}}:`,h=Object.values(e).some(e=>"string"==typeof e&&e.includes("\n"));if(a||Object.values(e).some(e=>Array.isArray(e))||h){const t=[l],r={...n,currentIndent:n.currentIndent+1};for(const s of i){const i=e[s];if(Array.isArray(i)||"object"==typeof i&&null!==i){const e=u(i,s,r);t.push(c(r.currentIndent,r.indent)+e)}else if(null===i)t.push(c(r.currentIndent,r.indent)+`${s}: null`);else if(!0===i||!1===i)t.push(c(r.currentIndent,r.indent)+`${s}: ${String(i)}`);else if("number"==typeof i)t.push(c(r.currentIndent,r.indent)+`${s}: ${String(i)}`);else if(void 0!==i){const e=o(String(i),n.delimiter);t.push(c(r.currentIndent,r.indent)+`${s}: ${e}`)}}return t.join("\n")}{const t=[l];for(const r of i){const i=e[r];if(null===i)t.push(`${r}: null`);else if(!0===i||!1===i)t.push(`${r}: ${String(i)}`);else if("number"==typeof i)t.push(`${r}: ${String(i)}`);else if(void 0!==i){const e=o(String(i),n.delimiter);t.push(`${r}: ${e}`)}}return t.join(" ")}}(e,t,n);if(!0===e||!1===e||null===e)return`${t}: ${String(e)}`;if("number"==typeof e)return`${t}: ${String(e)}`;return`${t}: ${o(String(e),n.delimiter)}`}class l extends Error{constructor(e,t,n,r){super(e),this.line=t,this.column=n,this.source=r,this.name="TONLError",Error.captureStackTrace(this,this.constructor)}toString(){let e=`${this.name}: ${this.message}`;const t="production"!==process.env.NODE_ENV;return void 0!==this.line&&(t?(e+=`\n  at line ${this.line}`,void 0!==this.column&&(e+=`:${this.column}`)):e+=` (line ${this.line})`),this.source&&t&&(e+=`\n\n  ${this.source}`,void 0!==this.column&&(e+=`\n  ${" ".repeat(this.column)}^`)),e}}class h extends l{constructor(e,t,n,r,i){super(e,t,n,r),this.suggestion=i,this.name="TONLParseError"}toString(){let e=super.toString();return this.suggestion&&(e+=`\n\nðŸ’¡ Suggestion: ${this.suggestion}`),e}}const p=1e5;function f(e,t=","){if(!e||""===e.trim())return[];if(e.length>p)throw new h(`Line exceeds maximum length: ${e.length} characters (max: 100000)`);const n={mode:"plain",currentField:"",fields:[],i:0};for(;n.i<e.length;){const r=e[n.i],i=e[n.i+1];switch(n.mode){case"plain":'"'===r?'"'===i&&'"'===e[n.i+2]?(n.mode="inTripleQuote",n.i+=2):n.mode="inQuote":"\\"===r&&void 0!==i&&i===t?(n.currentField+=t,n.i++):r===t?(n.fields.push(n.currentField.trim()),n.currentField=""):n.currentField+=r;break;case"inQuote":'"'===r?'"'===i?(n.currentField+='"',n.i++):n.mode="plain":n.currentField+=r;break;case"inTripleQuote":'"'===r&&'"'===i&&'"'===e[n.i+2]?(n.mode="plain",n.i+=2):n.currentField+=r}n.i++}if(n.fields.push(n.currentField.trim()),n.fields.length>1e4)throw new h(`Too many fields: ${n.fields.length} (max: 10000)`);return n.fields}function d(e){const t=e.trim();if(!t.startsWith("#"))return null;const n=t.match(/^#(\w+)\s+(.+)$/);return n?{key:n[1],value:n[2].trim()}:null}function m(e){const t=e.trim();if(!t.endsWith(":"))return null;const n=t.slice(0,-1);let r,i;const s=n.match(/^\[(\d+)\]/);if(s)r=`[${s[1]}]`,i=n.slice(s[0].length);else{const e=n.match(/^([a-zA-Z_][a-zA-Z0-9_]*)/);if(!e)return null;r=e[1],i=n.slice(r.length)}let o,c=!1,a=i;const u=i.match(/^\[(\d+)\]/);u&&(c=!0,o=parseInt(u[1],10),a=i.slice(u[0].length));const l=[],h=a.match(/^\{(.+)\}$/);if(h){const e=function(e){const t=[];let n="",r=!1;for(let i=0;i<e.length;i++){const s=e[i];'"'===s?i+1<e.length&&'"'===e[i+1]?(n+='""',i++):(r=!r,n+='"'):","!==s||r?n+=s:(t.push(n),n="")}n&&t.push(n);return t}(h[1]);for(const t of e){const e=t.trim();if(!e)continue;const n=e.indexOf(":");n>0?l.push({name:e.slice(0,n).trim(),type:e.slice(n+1).trim()}):l.push({name:e})}}return{key:r,isArray:c,arrayLength:o,columns:l}}function g(e){const t=e.match(/^#delimiter\s+([,|\t;])/m);if(t){const e=t[1];if(","===e||"|"===e||"\t"===e||";"===e)return e}const n=e.split("\n");for(const r of n){const e=r.trim();if(e&&!e.startsWith("#")&&!e.endsWith("{")&&!e.endsWith(":")){let t=0,n=0,r=0,i=0;for(let o=0;o<e.length;o++)switch(e[o]){case",":t++;break;case"|":n++;break;case"\t":r++;break;case";":i++}const s=Math.max(t,n,r,i);if(0===s)return",";if(t===s)return",";if(n===s)return"|";if(r===s)return"\t";if(i===s)return";"}}return","}function y(e,t){const n=e.trim();if("null"===n)return null;if("undefined"!==n){if("true"===n)return!0;if("false"===n)return!1;if("Infinity"===n)return 1/0;if("-Infinity"===n)return-1/0;if("NaN"===n)return NaN;if(n.startsWith('"""')&&n.endsWith('"""'))return n.slice(3,-3).replace(/\\"""/g,'"""').replace(/\\\\/g,"\\");if(n.startsWith('"')&&n.endsWith('"'))return function(e){return e.startsWith('"')&&e.endsWith('"')?e.slice(1,-1).replace(/""/g,'"').replace(/\\\\/g,"\\"):e}(n);if(/^-?\d+$/.test(n)){return parseInt(n,10)}if(/^-?\d*\.\d+$/.test(n)){return parseFloat(n)}if(/^-?\d+\.?\d*e[+-]?\d+$/i.test(n)){return parseFloat(n)}return n}}function E(e,t,n){if(!e)throw new Error("Header cannot be null in parseSingleLineObject");if(e.isArray){const r=f(t,n.delimiter),i=void 0!==e.arrayLength?e.arrayLength:Math.floor(r.length/e.columns.length),s=[];for(let t=0;t<i;t++){const n={};for(let i=0;i<e.columns.length;i++){const s=t*e.columns.length+i;if(s<r.length){const t=e.columns[i],o=r[s];n[t.name]=y(o)}}s.push(n)}return s}{const e={};let n=0;const r=t.length;for(;n<r;){const i=t.substring(n).match(/^([^:]+):\s*/);if(!i)break;const s=i[1].trim();n+=i[0].length;let o=r;const c=t.substring(n).match(/\s+[a-zA-Z0-9_]+\s*:/);c&&void 0!==c.index&&(o=n+c.index);const a=t.substring(n,o).trim();e[s]=y(a),n=o}return e}}function $(e,t){const n=[],r=e[t];if(!r)return n;const i=r.match(/^(\s*)/)?.[1]?.length||0;let s=t+1;for(;s<e.length;){const t=e[s];if(!t.trim()){n.push(t),s++;continue}if((t.match(/^(\s*)/)?.[1]?.length||0)<=i)break;n.push(t),s++}return n}function b(e,t,n){const r=e[t],i=r?.match(/^(\s*)/)?.[1]?.length||0;let s=t+1;for(;s<e.length;){const t=e[s],n=t.trim();if(!n){s++;continue}if((t.match(/^(\s*)/)?.[1]?.length||0)<=i&&(n.endsWith(":")||n.startsWith("#")))return s;s++}return s}function T(e,t,n,r){if(!e)throw new Error("Invalid header for block parsing");const s=[],o=t[n]?.match(/^(\s*)/)?.[1]?.length||0;let c=n+1,a=!1;for(;c<t.length;){const n=t[c],r=n.trim();if(!r){c++;continue}const i=n.match(/^(\s*)/)?.[1]?.length||0;let u=!1;if(r.includes('"""'))if((r.match(/"""/g)||[]).length,a)r.endsWith('"""')&&(a=!1,u=!0);else{const e=r.split('"""')[1];e&&!e.endsWith('"""')&&(a=!0)}if(!a&&i<o)break;if(!a&&!u&&i===o){const t=r.endsWith(":");if(!e.isArray||t)break}s.push(n),c++}return e.isArray?function(e,t,n){const r=[];if(e&&0!==e.columns.length)for(const s of t){const t=s.trim();if(!t||t.startsWith("#")||t.startsWith("@"))continue;const o=f(t,n.delimiter);if(0===o.length)continue;if(o.length>e.columns.length){if(n.strict)throw new Error(`Too many values for array with ${e.columns.length} columns: got ${o.length} values`);o.length=e.columns.length}const c={};for(let n=0;n<e.columns.length&&n<o.length;n++){const t=e.columns[n],r=o[n];if(r.startsWith("[")||r.includes("{"))c[t.name]=y(r);else{let e;e=t.type?i(r,t.type):y(r),c[t.name]=e}}r.push(c)}else{if(t.some(e=>null!==m(e.trim())))for(let e=0;e<t.length;e++){const i=t[e],s=i.trim();if(!s||s.startsWith("#")||s.startsWith("@"))continue;const o=m(s);if(o){const s=$(t,e),c=T(o,[i,...s],0,n),a=o.key.match(/^\[(\d+)\]$/);if(a){r[parseInt(a[1],10)]=c}else r.push(c);e+=s.length}}else if(t.length>0){const e=f(t[0],n.delimiter);for(const t of e)r.push(y(t))}}if(n.strict&&e&&void 0!==e.arrayLength&&r.length!==e.arrayLength)throw new Error(`Array length mismatch: expected ${e.arrayLength}, got ${r.length}`);return r}(e,s,r):function(e,t,n){const r={};let i=0;for(;i<t.length;){const e=t[i],s=e.trim();if(!s||s.startsWith("#")||s.startsWith("@")){i++;continue}const o=s.match(/^(.+)\{([^}]*)\}:\s+(.+)$/);if(o){const e=o[1].trim(),t=o[2].trim(),s=o[3].trim(),c=[];if(t){const e=t.split(",");for(const t of e){const e=t.trim();if(!e)continue;const n=e.indexOf(":");n>0?c.push({name:e.slice(0,n).trim(),type:e.slice(n+1).trim()}):c.push({name:e})}}const a={isArray:!1,columns:c};r[e]=E(a,s,n),i++;continue}const c=m(s);if(c){const s=$(t,i),o=T(c,[e,...s],0,n);r[c.key]=o,i+=s.length+1;continue}const a=s.match(/^(.+)\[(\d+)\]:\s*(.+)$/);if(a){const e=a[1].trim(),t=parseInt(a[2],10),s=a[3].trim();if(s.includes("{")||s.includes(":")){const i={isArray:!0,arrayLength:t,columns:[]};r[e]=E(i,s,n)}else{const t=f(s,n.delimiter),i=[];for(const e of t)i.push(y(e));r[e]=i}i++;continue}const u=s.match(/^([^:]+):\s*(.+)$/);if(u){const e=u[1].trim(),n=u[2].trim();if(n.startsWith('"""')){if(!n.endsWith('"""')){const s=[n.slice(3)];for(i++;i<t.length;){const e=t[i];if(e.trim().endsWith('"""')){const t=e.lastIndexOf('"""');if(t>=0){const n=e.match(/^([ \t]*)/)?.[1]?.length||0,r=e.slice(n,t);s.push(r)}i++;break}{const t=e.match(/^([ \t]*)/)?.[1]?.length||0,n=e.slice(t);s.push(n),i++}}r[e]=s.join("\n").replace(/\\"""/g,'"""').replace(/\\\\/g,"\\");continue}r[e]=n.slice(3,-3).replace(/\\"""/g,'"""').replace(/\\\\/g,"\\")}else r[e]=y(n);i++}else i++}return r}(0,s,r)}var v=(e=>(e.ROOT="ROOT",e.DOT="DOT",e.DOUBLE_DOT="DOUBLE_DOT",e.LBRACKET="LBRACKET",e.RBRACKET="RBRACKET",e.IDENTIFIER="IDENTIFIER",e.NUMBER="NUMBER",e.STRING="STRING",e.WILDCARD="WILDCARD",e.COLON="COLON",e.COMMA="COMMA",e.QUESTION="QUESTION",e.AT="AT",e.LPAREN="LPAREN",e.RPAREN="RPAREN",e.EQ="EQ",e.NEQ="NEQ",e.GT="GT",e.LT="LT",e.GTE="GTE",e.LTE="LTE",e.AND="AND",e.OR="OR",e.NOT="NOT",e.CONTAINS="CONTAINS",e.STARTS_WITH="STARTS_WITH",e.ENDS_WITH="ENDS_WITH",e.MATCHES="MATCHES",e.EOF="EOF",e))(v||{});class I extends Error{constructor(e,t,r){super(e),n(this,"input"),this.context=t,this.position=r,this.name="ParseError",this.input=t.input}getFormattedMessage(){const{input:e,position:t}=this,n=Math.max(0,t-20),r=Math.min(e.length,t+20),i=e.slice(n,r),s=" ".repeat(t-n)+"^";return`${this.message}\n\n  ${i}\n  ${s}\n  at position ${t}`}}function w(e){const t=[];let n=0;const r={input:e,position:0,tokens:[],currentToken:0};function i(t=0){const r=n+t;return r<e.length?e[r]:null}function s(){return n>=e.length?null:e[n++]}function o(){for(;n<e.length&&/\s/.test(e[n]);)n++}function c(){const t=n;let i="";if(!/[a-zA-Z_$]/.test(e[n]))throw new I(`Expected identifier at position ${n}`,r,n);for(;n<e.length&&/[a-zA-Z0-9_$]/.test(e[n]);)i+=e[n++];return{type:{contains:v.CONTAINS,startsWith:v.STARTS_WITH,endsWith:v.ENDS_WITH,matches:v.MATCHES}[i]||v.IDENTIFIER,value:i,position:t,length:i.length}}function a(){const t=n;let o="";if("-"===i()&&(o+=s()),!/\d/.test(i()||""))throw new I(`Expected digit at position ${n}`,r,n);for(;n<e.length&&/\d/.test(e[n]);)o+=e[n++];if("."===i()&&i(1)&&/\d/.test(i(1)))for(o+=s();n<e.length&&/\d/.test(e[n]);)o+=e[n++];return{type:v.NUMBER,value:parseFloat(o),position:t,length:o.length}}function u(){const t=n,i=s();let o="",c=!1;for(;n<e.length;){const r=e[n];if(c){switch(r){case"n":o+="\n";break;case"t":o+="\t";break;case"r":o+="\r";break;case"\\":o+="\\";break;case i:o+=i;break;default:o+="\\"+r}c=!1,n++}else if("\\"===r)c=!0,n++;else{if(r===i)return n++,{type:v.STRING,value:o,position:t,length:n-t};o+=r,n++}}throw new I(`Unterminated string literal starting at position ${t}`,r,t)}function l(){const t=n,r=e.slice(n,n+2),i={"==":v.EQ,"!=":v.NEQ,">=":v.GTE,"<=":v.LTE,"&&":v.AND,"||":v.OR,"..":v.DOUBLE_DOT};return i[r]?(n+=2,{type:i[r],value:r,position:t,length:2}):null}for(;n<e.length&&(o(),!(n>=e.length));){const e=n,o=i();if(!o)break;const h=l();if(h)t.push(h);else switch(o){case"$":i(1)&&/[a-zA-Z_$]/.test(i(1))?t.push(c()):(t.push({type:v.ROOT,value:"$",position:e,length:1}),s());break;case".":t.push({type:v.DOT,value:".",position:e,length:1}),s();break;case"[":t.push({type:v.LBRACKET,value:"[",position:e,length:1}),s();break;case"]":t.push({type:v.RBRACKET,value:"]",position:e,length:1}),s();break;case"*":t.push({type:v.WILDCARD,value:"*",position:e,length:1}),s();break;case":":t.push({type:v.COLON,value:":",position:e,length:1}),s();break;case",":t.push({type:v.COMMA,value:",",position:e,length:1}),s();break;case"?":t.push({type:v.QUESTION,value:"?",position:e,length:1}),s();break;case"@":t.push({type:v.AT,value:"@",position:e,length:1}),s();break;case"(":t.push({type:v.LPAREN,value:"(",position:e,length:1}),s();break;case")":t.push({type:v.RPAREN,value:")",position:e,length:1}),s();break;case">":t.push({type:v.GT,value:">",position:e,length:1}),s();break;case"<":t.push({type:v.LT,value:"<",position:e,length:1}),s();break;case"!":t.push({type:v.NOT,value:"!",position:e,length:1}),s();break;case'"':case"'":t.push(u());break;default:if(/\d/.test(o)||"-"===o&&i(1)&&/\d/.test(i(1)))t.push(a());else{if(!/[a-zA-Z_$]/.test(o))throw new I(`Unexpected character '${o}' at position ${n}`,r,n);t.push(c())}}}return t.push({type:v.EOF,value:null,position:n,length:0}),r.tokens=t,t}function N(e){return{[v.OR]:1,[v.AND]:2,[v.EQ]:3,[v.NEQ]:3,[v.GT]:4,[v.LT]:4,[v.GTE]:4,[v.LTE]:4,[v.CONTAINS]:4,[v.STARTS_WITH]:4,[v.ENDS_WITH]:4,[v.MATCHES]:4,[v.NOT]:5}[e.type]||0}class k{constructor(e,t){n(this,"currentIndex",0),this.context=e,this.options=t}current(){return this.context.tokens[this.currentIndex]||this.context.tokens[this.context.tokens.length-1]}peek(e=1){const t=this.currentIndex+e;return t<this.context.tokens.length?this.context.tokens[t]:null}consume(){const e=this.current();return this.currentIndex++,e}match(...e){const t=this.current();return e.includes(t.type)}expect(e,t){const n=this.current();if(n.type!==e)throw new I(t||`Expected ${e} but got ${n.type}`,this.context,n.position);return this.consume()}parse(){const e=[];for(this.match(v.ROOT)&&(this.consume(),e.push({type:"root",symbol:"$"}));!this.match(v.EOF);)if(this.match(v.DOUBLE_DOT))e.push(this.parseRecursive());else if(this.match(v.DOT)){if(this.consume(),this.match(v.IDENTIFIER))e.push(this.parseProperty());else if(this.match(v.WILDCARD))this.consume(),e.push({type:"wildcard"});else if(!this.match(v.EOF))throw new I("Expected property name or wildcard after dot",this.context,this.current().position)}else if(this.match(v.LBRACKET))e.push(this.parseBracketNotation());else if(0===e.length&&this.match(v.IDENTIFIER))e.push(this.parseProperty());else{if(0!==e.length||!this.match(v.WILDCARD)){if(!this.match(v.EOF)){const e=this.current();throw new I(`Unexpected token: ${e.type}`,this.context,e.position)}break}this.consume(),e.push({type:"wildcard"})}return e}parseProperty(){return{type:"property",name:this.expect(v.IDENTIFIER).value}}parseRecursive(){if(this.expect(v.DOUBLE_DOT),this.match(v.IDENTIFIER)){return{type:"recursive",name:this.consume().value}}return{type:"recursive"}}parseBracketNotation(){if(this.expect(v.LBRACKET),this.match(v.WILDCARD))return this.consume(),this.expect(v.RBRACKET),{type:"wildcard"};if(this.match(v.QUESTION))return this.parseFilter();const e=this.current();if(this.match(v.NUMBER)){const e=this.consume().value;return this.match(v.COLON)?this.parseSlice(e):(this.expect(v.RBRACKET),{type:"index",index:e})}if(this.match(v.COLON))return this.parseSlice(void 0);throw new I("Expected number, wildcard, or filter in bracket notation",this.context,e.position)}parseSlice(e){let t,n;return this.expect(v.COLON),this.match(v.NUMBER)&&(t=this.consume().value),this.match(v.COLON)&&(this.consume(),this.match(v.NUMBER)&&(n=this.consume().value)),this.expect(v.RBRACKET),{type:"slice",start:e,end:t,step:n}}parseFilter(){this.expect(v.QUESTION),this.expect(v.LPAREN);const e=this.parseFilterExpression();return this.expect(v.RPAREN),this.expect(v.RBRACKET),{type:"filter",expression:e}}parseFilterExpression(e=0){let t=this.parseFilterPrimary();for(;;){const n=this.current();if(!this.isFilterBinaryOperator(n.type))break;const r=N(n);if(r<e)break;const i=this.consume(),s=this.parseFilterExpression(r+1);t={type:"binary",operator:this.tokenTypeToBinaryOperator(i.type),left:t,right:s}}return t}parseFilterPrimary(){if(this.match(v.LPAREN)){this.consume();const e=this.parseFilterExpression();return this.expect(v.RPAREN),e}if(this.match(v.NOT)){this.consume();return{type:"unary",operator:"!",argument:this.parseFilterPrimary()}}if(this.match(v.AT))return this.parsePropertyExpression();if(this.match(v.NUMBER,v.STRING)){return{type:"literal",value:this.consume().value}}if(this.match(v.IDENTIFIER)){const e=this.peek();if(e&&e.type===v.LPAREN)return this.parseFunctionExpression();const t=this.consume();if("true"===t.value)return{type:"literal",value:!0};if("false"===t.value)return{type:"literal",value:!1};if("null"===t.value)return{type:"literal",value:null};throw new I(`Unexpected identifier in filter: ${t.value}`,this.context,t.position)}throw new I(`Expected filter expression but got ${this.current().type}`,this.context,this.current().position)}parsePropertyExpression(){this.expect(v.AT);const e=[];for(;this.match(v.DOT);){if(this.consume(),!this.match(v.IDENTIFIER))throw new I("Expected property name after dot",this.context,this.current().position);e.push(this.consume().value)}return{type:"property",path:e.join(".")}}parseFunctionExpression(){const e=this.expect(v.IDENTIFIER);this.expect(v.LPAREN);const t=[];if(!this.match(v.RPAREN))for(t.push(this.parseFilterExpression());this.match(v.COMMA);)this.consume(),t.push(this.parseFilterExpression());return this.expect(v.RPAREN),{type:"function",name:e.value,arguments:t}}isFilterBinaryOperator(e){return[v.EQ,v.NEQ,v.GT,v.LT,v.GTE,v.LTE,v.AND,v.OR,v.CONTAINS,v.STARTS_WITH,v.ENDS_WITH,v.MATCHES].includes(e)}tokenTypeToBinaryOperator(e){return{[v.EQ]:"==",[v.NEQ]:"!=",[v.GT]:">",[v.LT]:"<",[v.GTE]:">=",[v.LTE]:"<=",[v.AND]:"&&",[v.OR]:"||",[v.CONTAINS]:"contains",[v.STARTS_WITH]:"startsWith",[v.ENDS_WITH]:"endsWith",[v.MATCHES]:"matches"}[e]||"=="}}function A(e){switch(e.type){case"property":if(!e.name||0===e.name.length)throw new Error("Property node must have a non-empty name");break;case"index":if(!Number.isInteger(e.index))throw new Error("Index must be an integer");break;case"slice":if(void 0!==e.start&&!Number.isInteger(e.start))throw new Error("Slice start must be an integer");if(void 0!==e.end&&!Number.isInteger(e.end))throw new Error("Slice end must be an integer");if(void 0!==e.step&&!Number.isInteger(e.step))throw new Error("Slice step must be an integer");if(0===e.step)throw new Error("Slice step cannot be zero");break;case"filter":O(e.expression);break;case"root":case"wildcard":case"recursive":break;default:throw new Error(`Unknown node type: ${e.type}`)}}function O(e){switch(e.type){case"binary":O(e.left),O(e.right);break;case"unary":O(e.argument);break;case"function":for(const t of e.arguments)O(t);break;case"literal":case"property":break;default:throw new Error(`Unknown filter expression type: ${e.type}`)}}function x(e){const t=[];switch(e.type){case"property":e.name&&0!==e.name.length||t.push("Property node must have a non-empty name"),/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(e.name)||t.push(`Invalid property name: ${e.name}`);break;case"index":Number.isInteger(e.index)||t.push(`Index must be an integer, got: ${e.index}`);break;case"slice":if(void 0===e.start||Number.isInteger(e.start)||t.push(`Slice start must be an integer, got: ${e.start}`),void 0===e.end||Number.isInteger(e.end)||t.push(`Slice end must be an integer, got: ${e.end}`),void 0!==e.step&&(Number.isInteger(e.step)||t.push(`Slice step must be an integer, got: ${e.step}`),0===e.step&&t.push("Slice step cannot be zero")),void 0!==e.start&&void 0!==e.end&&e.start>e.end){const n=void 0!==e.step&&e.step<0,r=e.start<0||e.end<0;n||r||t.push(`Slice start (${e.start}) is greater than end (${e.end})`)}break;case"filter":const n=S(e.expression);t.push(...n);break;case"root":"$"!==e.symbol&&t.push(`Root node must have symbol '$', got: ${e.symbol}`);break;case"wildcard":case"recursive":break;default:t.push(`Unknown node type: ${e.type}`)}return t}function R(e,t,n){const r=[];return"root"===e.type&&0!==n&&r.push("Root node ($) must be the first node in the path"),t&&"root"===t.type&&"root"===e.type&&r.push("Cannot have multiple root nodes"),r}function S(e){const t=[];switch(e.type){case"binary":["==","!=",">","<",">=","<=","&&","||","contains","startsWith","endsWith","matches","in","typeof","instanceof"].includes(e.operator)||t.push(`Invalid binary operator: ${e.operator}`),t.push(...S(e.left)),t.push(...S(e.right));break;case"unary":["!","exists","empty"].includes(e.operator)||t.push(`Invalid unary operator: ${e.operator}`),t.push(...S(e.argument));break;case"function":e.name&&0!==e.name.length||t.push("Function expression must have a name");for(const n of e.arguments)t.push(...S(n));break;case"property":e.path&&0!==e.path.length||t.push("Property expression must have a non-empty path");break;case"literal":break;default:t.push(`Unknown filter expression type: ${e.type}`)}return t}function L(e){switch(e.type){case"binary":return`${L(e.left)} ${e.operator} ${L(e.right)}`;case"unary":return`${e.operator}${L(e.argument)}`;case"literal":return"string"==typeof e.value?`"${e.value}"`:String(e.value);case"property":return"@."+e.path;case"function":const t=e.arguments.map(e=>L(e)).join(", ");return`${e.name}(${t})`;default:return""}}return e.ParseError=I,e.TokenType=v,e.analyzeAST=function(e){const t={};let n=!1,r=!1,i=!1,s=!0;for(const c of e)t[c.type]=(t[c.type]||0)+1,"wildcard"===c.type&&(n=!0,s=!1),"recursive"===c.type&&(r=!0,s=!1),"filter"===c.type&&(i=!0,s=!1),"slice"===c.type&&(s=!1);let o=1;return o+=.5*e.length,n&&(o+=2),r&&(o+=3),i&&(o+=2),o=Math.min(10,Math.round(o)),{depth:e.length,hasWildcard:n,hasRecursive:r,hasFilter:i,isDeterministic:s,complexity:o,nodeTypes:t}},e.astToString=function(e){if(0===e.length)return"";let t="";for(let n=0;n<e.length;n++){const r=e[n],i=n>0?e[n-1]:null;switch(r.type){case"root":t+="$";break;case"property":(i&&"root"!==i.type||i)&&(t+="."),t+=r.name;break;case"index":t+=`[${r.index}]`;break;case"wildcard":i&&"property"===i.type?t+="[*]":t+="*";break;case"recursive":t+="..",r.name&&(t+=r.name);break;case"slice":t+="[",void 0!==r.start&&(t+=r.start),t+=":",void 0!==r.end&&(t+=r.end),void 0!==r.step&&(t+=":"+r.step),t+="]";break;case"filter":t+="[?("+L(r.expression)+")]"}}return t},e.coerceValue=i,e.decodeTONL=function(e,t={}){const n=t.strict??!1,r=e.split("\n").map(e=>e.replace(/\r$/,"")).filter(e=>e.length>0);if(0===r.length)return{};const i={header:{},strict:n,delimiter:t.delimiter||","};let s=0;for(let a=0;a<r.length;a++){const e=r[a];if(e.startsWith("@"))s=a+1;else{if(!e.startsWith("#"))break;{const t=d(e);if(t)if("version"===t.key)i.header.version=t.value;else if("delimiter"===t.key)if("\\t"===t.value)i.header.delimiter="\t";else{if(","!==t.value&&"|"!==t.value&&";"!==t.value)throw new h(`Invalid delimiter: ${t.value}`,a,void 0,e,"Valid delimiters are: , | \\t ;");i.header.delimiter=t.value}s=a+1}}}t.delimiter||(i.header.delimiter?i.delimiter=i.header.delimiter:i.delimiter=g(e));const o=r.slice(s).join("\n");if(!o)return{};const c=function(e,t){const n=e.split("\n"),r={};let i=0;for(;i<n.length;){const e=n[i].trim();if(!e||e.startsWith("#")||e.startsWith("@")){i++;continue}const s=e.match(/^(.+)\{([^}]*)\}:\s+(.+)$/);if(s){const e=s[1].trim(),n=s[2].trim(),o=s[3].trim(),c=[];if(n){const e=n.split(",");for(const t of e){const e=t.trim();if(!e)continue;const n=e.indexOf(":");n>0?c.push({name:e.slice(0,n).trim(),type:e.slice(n+1).trim()}):c.push({name:e})}}const a={key:e,isArray:!1,columns:c},u=E(a,o,t);r[a.key]=u,i++;continue}const o=m(e);if(o){const e=T(o,n,i,t);r[o.key]=e,i=b(n,i)}else{const n=e.match(/^(.+)\[(\d+)\]:\s*(.+)$/);if(n){const e=n[1].trim();parseInt(n[2],10);const s=f(n[3].trim(),t.delimiter),o=[];for(const t of s)o.push(y(t));r[e]=o,i++;continue}const s=e.match(/^([^:]+):\s*(.+)$/);if(s){const e=s[1].trim(),t=s[2].trim();r[e]=y(t)}i++}}return r}(o,i);return c&&"object"==typeof c&&1===Object.keys(c).length&&"root"in c?c.root:c},e.detectDelimiter=g,e.encodeSmart=function(e,t){const n=JSON.stringify(e),r=(n.match(/,/g)||[]).length,i=(n.match(/\|/g)||[]).length,s=(n.match(/\t/g)||[]).length,o=(n.match(/;/g)||[]).length;let c=",",u=r;return i<u&&(c="|",u=i),s<u&&(c="\t",u=s),o<u&&(c=";",u=o),a(e,{delimiter:c,includeTypes:!1,version:"1.0",indent:2,singleLinePrimitiveLists:!0,...t})},e.encodeTONL=a,e.inferPrimitiveType=r,e.isUniformObjectArray=s,e.optimizeAST=function(e){if(0===e.length)return e;const t=[];for(let n=0;n<e.length;n++){const r=e[n];t[t.length-1],0===n&&"root"===r.type&&e.length,t.push(r)}return t},e.parseHeaderLine=d,e.parseObjectHeader=m,e.parsePath=function(e,t={}){const{validate:n=!0,allowPartial:r=!1,maxRecursionDepth:i=100}=t;try{const t=w(e),s=new k({input:e,position:0,tokens:t,currentToken:0},{allowPartial:r,maxRecursionDepth:i}).parse();return n&&s.length>0&&function(e){const t=e.filter(e=>"recursive"===e.type).length;if(t>10)throw new Error("Too many recursive descent operators in path");for(const n of e)A(n)}(s),{ast:s,success:!0,input:e}}catch(s){if(s instanceof I)return{ast:[],success:!1,error:s,input:e};throw s}},e.parseTONLLine=f,e.tokenize=w,e.validate=function(e){const t=[],n=[];if(0===e.length)return n.push("Empty path"),{valid:!0,errors:t,warnings:n};for(let i=0;i<e.length;i++){const n=e[i],r=i>0?e[i-1]:null,s=x(n);t.push(...s);const o=R(n,r,i);t.push(...o)}const r=function(e){const t=[],n=e.filter(e=>"recursive"===e.type).length;n>5&&t.push(`Path contains ${n} recursive descents, which may be slow`);for(let r=0;r<e.length-1;r++)"wildcard"===e[r].type&&"filter"===e[r+1].type&&t.push("Wildcard followed by filter at index "+r+" - consider filter optimization");for(let r=0;r<e.length-1;r++)"wildcard"===e[r].type&&"wildcard"===e[r+1].type&&t.push("Consecutive wildcards at index "+r+" may return unexpected results");return t}(e);return n.push(...r),{valid:0===t.length,errors:t,warnings:n}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),e}({});
